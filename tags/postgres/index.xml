<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Postgres - 标签 - LEON BLOG</title><link>https://blog.liangml.dpdns.org/tags/postgres/</link><description>运维小站，分享些技术经验。</description><generator>Hugo 0.156.0 &amp; FixIt v0.4.2</generator><language>zh-CN</language><lastBuildDate>Mon, 14 Oct 2024 19:16:55 +0800</lastBuildDate><atom:link href="https://blog.liangml.dpdns.org/tags/postgres/index.xml" rel="self" type="application/rss+xml"/><item><title>Postgres</title><link>https://blog.liangml.dpdns.org/posts/postgres/</link><pubDate>Mon, 14 Oct 2024 19:16:55 +0800</pubDate><guid>https://blog.liangml.dpdns.org/posts/postgres/</guid><category domain="https://blog.liangml.dpdns.org/categories/postgres/">Postgres</category><description>&lt;h1 class="heading-element" id="导出"&gt;&lt;span&gt;导出&lt;/span&gt;
 &lt;a href="#%e5%af%bc%e5%87%ba" class="heading-mark"&gt;
 &lt;svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"&gt;&lt;path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"&gt;&lt;/path&gt;&lt;/svg&gt;
 &lt;/a&gt;
&lt;/h1&gt;&lt;pre&gt;&lt;code&gt;pg_dump -h IPADRESS -U USERNAME -t TABLENAME --column-inserts DATABASENAME &amp;gt; BACKUPNAME.sql&lt;/code&gt;&lt;/pre&gt;&lt;h1 class="heading-element" id="表owner批量授权"&gt;&lt;span&gt;表owner批量授权&lt;/span&gt;
 &lt;a href="#%e8%a1%a8owner%e6%89%b9%e9%87%8f%e6%8e%88%e6%9d%83" class="heading-mark"&gt;
 &lt;svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"&gt;&lt;path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"&gt;&lt;/path&gt;&lt;/svg&gt;
 &lt;/a&gt;
&lt;/h1&gt;&lt;pre&gt;&lt;code&gt;REASSIGN OWNEDBY old_role [,...] TO new_role&lt;/code&gt;&lt;/pre&gt;&lt;h1 class="heading-element" id="主从配置"&gt;&lt;span&gt;主从配置&lt;/span&gt;
 &lt;a href="#%e4%b8%bb%e4%bb%8e%e9%85%8d%e7%bd%ae" class="heading-mark"&gt;
 &lt;svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"&gt;&lt;path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"&gt;&lt;/path&gt;&lt;/svg&gt;
 &lt;/a&gt;
&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;主节点配置&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;# 安装postgre
# 切换postgres
su - postgres
# 登录
psql
# 管理员用户配置密码
ALTER USER postgres WITH PASSWORD &amp;#39;YourPassWord&amp;#39;;
# 创建备份账号及权限
CREATE ROLE replica login replication encrypted password &amp;#39;replica&amp;#39;;
# 验证账号是否成功
SELECT usename from pg_user;
# 验证权限
SELECT rolname from pg_roles;
# 编辑pg_hba.conf,设置replica用户白名单
vim /var/lib/pgsql/9.6/data/pg_hba.conf
host all all &amp;lt;从节点的VPC IPv4网段&amp;gt; md5 #允许VPC网段中md5密码认证连接
host replication replica &amp;lt;从节点的VPC IPv4网段&amp;gt; md5 #允许用户从replication数据库进行数据同步
# 编辑postgresql.conf
vim /var/lib/pgsql/9.6/data/postgresql.conf
# 分别找到以下参数
listen_addresses = &amp;#39;*&amp;#39; #监听的IP地址
wal_level = hot_standby #启用热备模式
synchronous_commit = on #开启同步复制
max_wal_senders = 32 #同步最大的进程数量
wal_sender_timeout = 60s #流复制主机发送数据的超时时间
max_connections = 100 #最大连接数，从库的max_connections必须要大于主库的
# 重启服务
systemctl restart postgresql-9.6.service&lt;/code&gt;&lt;/pre&gt;&lt;ol start="2"&gt;
&lt;li&gt;从节点配置&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;# 运行以下命令使用pg_basebackup基础备份工具指定备份目录。
pg_basebackup -D /var/lib/pgsql/9.6/data -h &amp;lt;主节点IP&amp;gt; -p 5432 -U replica -X stream -P
# 依次运行以下命令新建并修改recovery.conf配置文件。
cp /usr/pgsql-9.6/share/recovery.conf.sample /var/lib/pgsql/9.6/data/recovery.conf
vim /var/lib/pgsql/9.6/data/recovery.conf
# 分别找到以下参数，并将参数修改为以下内容：
standby_mode = on #声明此节点为从库
primary_conninfo = ‘host=&amp;lt;主节点IP&amp;gt; port=5432 user=replica password=replica’ #对应主库的连接信息
recovery_target_timeline = ‘latest’ #流复制同步到最新的数据
# 运行以下命令打开postgresql.conf文件。
vim /var/lib/pgsql/9.6/data/postgresql.conf
max_connections = 1000 # 最大连接数，从节点需设置比主节点大
hot_standby = on # 开启热备
max_standby_streaming_delay = 30s # 数据流备份的最大延迟时间
wal_receiver_status_interval = 1s # 从节点向主节点报告自身状态的最长间隔时间
hot_standby_feedback = on # 如果有错误的数据复制向主进行反馈
# 运行以下命令修改数据目录的属组和属主
chown -R postgres.postgres /var/lib/pgsql/9.6/data&lt;/code&gt;&lt;/pre&gt;&lt;ol start="3"&gt;
&lt;li&gt;检测验证&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;# 检测验证需要主从节点之间存在数据交互，例如，从节点备份目录时，进行检测能够得到预期的结果。
pg_basebackup -D /var/lib/pgsql/96/data -h &amp;lt;主节点IP&amp;gt; -p 5432 -U replica -X stream -P
# 在主节点中运行以下命令查看sender进程。
ps aux |grep sender
# 在从节点中运行以下命令查看receiver进程。
ps aux |grep receiver
# 在主节点中进入PostgreSQL交互终端，输入以下SQL语句，在主库中查看从库状态。
select * from pg_stat_replication;&lt;/code&gt;&lt;/pre&gt;</description></item></channel></rss>